---
import BaseLayout from "../layouts/BaseLayout.astro";
import participantsCsv from "../../Winter-Wochenende_2026.csv?raw";
import { parseCsv } from "../lib/csvLoader";
import { fetchCampflowEvents, fetchCampflowParticipants } from "../lib/campflow";
import { computePlan, groupPriorityOrder, planToCsv } from "../lib/planner";
import type { CampflowEvent, Participant } from "../lib/types";

const MODE = (import.meta.env?.MODE ?? "development").toLowerCase();
const isProd = MODE === "production";
const token = import.meta.env?.CAMPFLOW_TOKEN ?? "";

const sampleEvents: CampflowEvent[] = [
  { id: "event-1", name: "Winter-Wochenende 2026", startDate: "2026-02-14" },
  { id: "event-2", name: "Sommerlager 2026", startDate: "2026-08-02" },
];

const groupPriority = groupPriorityOrder;

let events: CampflowEvent[] = sampleEvents;
let participants: Participant[] = parseCsv(participantsCsv);
let modeLabel = "Entwicklung (CSV)";

if (isProd) {
  if (!token) {
    events = sampleEvents;
    participants = parseCsv(participantsCsv);
    modeLabel = "Prod ohne Token → CSV";
  } else {
    try {
      events = await fetchCampflowEvents(token);
      if (events.length === 0) {
        events = sampleEvents;
      }
      if (events[0]?.id) {
        participants = await fetchCampflowParticipants(events[0].id, token);
      }
      modeLabel = "Production (Campflow)";
    } catch (err) {
      console.warn("Campflow fetch failed, fallback CSV", err);
      events = sampleEvents;
      participants = parseCsv(participantsCsv);
      modeLabel = "Fallback (CSV)";
    }
  }
}

const planHin = computePlan(participants, "Hinfahrt");
const planRueck = computePlan(participants, "Rückfahrt");
const csvExportText = [planToCsv(planHin), planToCsv(planRueck)].join("\n\n");

---


<BaseLayout title="Carpool Planner">
  <header class="flex flex-col gap-2">
    <p class="text-sm font-semibold text-slate-300 uppercase tracking-wide">DPSG Carpool Planner</p>
    <h1 class="text-3xl font-bold text-white">Events & Fahrten planen</h1>
    <p class="text-sm text-slate-300">Campflow-Events laden (Dropdown), CSV-Demo nutzen, Hin- und Rückfahrt getrennt planen, Leiter priorisiert. DPSG-Farben, Export (CSV/Copy) vorgesehen.</p>
    <div class="text-xs text-amber-300 bg-amber-500/10 border border-amber-500/40 rounded-lg px-3 py-2 inline-flex items-center gap-2">
      <span class="inline-block h-2 w-2 rounded-full bg-amber-400"></span>
      <span>Modus: {modeLabel} ({isProd ? "prod" : "dev"})</span>
    </div>
  </header>

  <section class="rounded-2xl border border-slate-800 bg-slate-950/60 p-4 shadow-lg shadow-slate-900/40">
    <h2 class="text-lg font-semibold text-white">Event-Auswahl</h2>
    <p class="text-sm text-slate-300 mb-3">Später via Campflow-API: Dropdown zum gewünschten Event. Aktuell Demo-Events.</p>
    <div class="flex flex-col gap-3 md:flex-row md:items-center">
      <label class="text-sm text-slate-200" for="event">Event</label>
      <select id="event" name="event" class="w-full md:w-auto rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-white focus:border-blue-400 focus:outline-none">
        {events.map((evt) => (
          <option value={evt.id}>
            {evt.name} · {evt.startDate ?? ""}
          </option>
        ))}
      </select>
      <button class="inline-flex items-center justify-center rounded-lg bg-blue-500 px-3 py-2 text-sm font-semibold text-white hover:bg-blue-400 transition-colors" type="button">Campflow aktualisieren</button>
    </div>
  </section>

  <section class="grid gap-4 md:grid-cols-2">
    <div class="rounded-2xl border border-slate-800 bg-slate-950/60 p-4 shadow-lg shadow-slate-900/40">
      <h3 class="text-base font-semibold text-white">Teilnehmer (CSV-Demo)</h3>
      <p class="text-sm text-slate-300 mb-3">Vor- und Nachname sind das Kind; Anzahl inkl. eigenes Kind.</p>
      <div class="rounded-lg border border-slate-800 bg-slate-900/80 px-3 py-2 text-sm text-slate-200">
        <ul class="space-y-1 max-h-64 overflow-auto pr-1">
          {participants.map((p) => (
            <li class="flex justify-between">
              <span>{p.Vorname} {p.Nachname} ({p.Gruppen})</span>
              <span class="text-slate-400">H {p.Hinfahrt} · R {p.Rückfahrt}</span>
            </li>
          ))}
        </ul>
      </div>
      <p class="text-xs text-slate-400 mt-2">CSV bleibt lokal (nicht committen). Später durch Campflow-Teilnehmer ersetzt.</p>
    </div>

    <div class="rounded-2xl border border-slate-800 bg-slate-950/60 p-4 shadow-lg shadow-slate-900/40">
      <h3 class="text-base font-semibold text-white">Fahrer-Priorität</h3>
      <p class="text-sm text-slate-300 mb-3">Leiter zuerst, dann restliche Gruppen.</p>
      <ol class="space-y-1 text-sm text-slate-200 list-decimal list-inside">
        {groupPriority.map((g) => (
          <li>{g}</li>
        ))}
      </ol>
      <p class="text-xs text-slate-400 mt-2">Platzlimit je Fahrzeug: max laut Eventdaten (Hin/Rück getrennt).</p>
    </div>
  </section>

  <section class="rounded-2xl border border-slate-800 bg-slate-950/60 p-4 shadow-lg shadow-slate-900/40">
    <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
      <div>
        <h3 class="text-base font-semibold text-white">Fahrtenplanung</h3>
        <p class="text-sm text-slate-300">Hin- und Rückfahrt getrennt; manuelle Anpassung möglich.</p>
      </div>
      <div class="flex gap-2 text-sm">
        <button class="rounded-lg bg-slate-800 px-3 py-2 text-white border border-slate-700">Autos vorschlagen</button>
        <button
          id="export-csv"
          class="rounded-lg bg-blue-500 px-3 py-2 text-white font-semibold hover:bg-blue-400"
          type="button"
        >
          CSV Export
        </button>
        <button
          id="copy-csv"
          class="rounded-lg bg-slate-700 px-3 py-2 text-white"
          type="button"
        >
          Copy
        </button>
        <button class="rounded-lg bg-amber-500/90 px-3 py-2 text-slate-900 font-semibold hover:bg-amber-400" type="button">PDF (später)</button>
      </div>
      <script define:vars={{ csvExportText }}>
        const csvText = csvExportText;
        const exportBtn = document.getElementById('export-csv');
        const copyBtn = document.getElementById('copy-csv');
        if (exportBtn) {
          exportBtn.addEventListener('click', () => {
            const blob = new Blob([csvText], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'fahrten.csv';
            a.click();
            URL.revokeObjectURL(url);
          });
        }
        if (copyBtn) {
          copyBtn.addEventListener('click', () => {
            navigator.clipboard?.writeText(csvText).catch(() => {});
          });
        }
      </script>

    </div>
    <div class="mt-3 grid gap-3 md:grid-cols-2">
      {(["Hinfahrt", "Rückfahrt"] as const).map((dir) => {
        const plan = computePlan(participants, dir);
        return (
          <div class="rounded-xl border border-slate-800 bg-slate-900/80 p-3">
            <h4 class="text-sm font-semibold text-white mb-2">{dir}</h4>
            <ul class="space-y-2 text-sm text-slate-200">
              {plan.cars.map((car) => (
                <li class="rounded-lg border border-slate-700/80 bg-slate-800/60 p-2">
                  <div class="flex justify-between">
                    <span>Fahrer: {car.driver.Vorname} {car.driver.Nachname} ({car.driver.Gruppen})</span>
                    <span>Sitze: {car.seatsTotal}</span>
                  </div>
                  <div class="text-slate-300">Mitfahrende: {car.passengers.map((p) => `${p.Vorname} ${p.Nachname}`).join(", ") || "-"}</div>
                </li>
              ))}
              {plan.leftovers.length > 0 && (
                <li class="rounded-lg border border-amber-500/40 bg-amber-500/10 p-2 text-amber-100">
                  <div class="font-semibold">Ohne Platz:</div>
                  <div class="text-amber-200 text-sm">{plan.leftovers.map((p) => `${p.Vorname} ${p.Nachname}`).join(", ")}</div>
                </li>
              )}
            </ul>
            <div class="mt-2 text-xs text-slate-400">Plätze: {plan.seatsAvailable} / Bedarf: {plan.demand}</div>
          </div>
        );
      })}
    </div>
  </section>
</BaseLayout>
